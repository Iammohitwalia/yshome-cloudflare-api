<!-- Cloudflare Turnstile Script for Webflow -->
<!-- Paste this in Project Settings ‚Üí Custom Code ‚Üí Footer -->

<script>
(function () {
  function initTurnstile() {
    // Wait for Turnstile API to be ready
    if (typeof window.turnstile === 'undefined') {
      console.error('Turnstile API not loaded');
      return;
    }

    document.querySelectorAll("form").forEach(function (form) {
      const submitBtn = form.querySelector('input[type="submit"], button[type="submit"]');
      if (!submitBtn) return;

      // Create container for Turnstile widget
      const turnstileBox = document.createElement("div");
      turnstileBox.className = "cf-turnstile-container";
      turnstileBox.style.marginBottom = "16px";
      turnstileBox.style.minHeight = "65px"; // Ensure space for widget

      // Insert BEFORE submit button
      submitBtn.parentNode.insertBefore(turnstileBox, submitBtn);

      let token = null;
      let widgetId = null;
      let isVerifying = false;

      // Render Turnstile with INTERACTIVE mode (forces challenge)
      try {
        widgetId = window.turnstile.render(turnstileBox, {
          sitekey: "0x4AAAAAACHF7f3F-7Drnnj7",
          theme: "light",
          size: "normal", // Normal size ensures challenge appears
          callback: function (t) {
            token = t;
            console.log("‚úÖ Turnstile token generated:", t.substring(0, 20) + "...");
          },
          "error-callback": function () {
            token = null;
            console.error("‚ùå Turnstile error - challenge failed");
          },
          "expired-callback": function () {
            token = null;
            console.warn("‚ö†Ô∏è Turnstile token expired");
          }
        });
      } catch (err) {
        console.error("Failed to render Turnstile:", err);
        return;
      }

      // Track if verification passed - CRITICAL for preventing submission
      let verificationPassed = false;

      // Handle form submission
      const handleSubmit = async function (e) {
        e.preventDefault();
        e.stopPropagation(); // Stop any other handlers

        // If verification already passed, allow submission
        if (verificationPassed) {
          console.log("‚úÖ Verification already passed, allowing submission");
          form.removeEventListener("submit", handleSubmit);
          HTMLFormElement.prototype.submit.call(form);
          return;
        }

        // Prevent double submission
        if (isVerifying) {
          console.log("‚è≥ Verification already in progress...");
          return false;
        }

        // Check if token exists
        if (!token) {
          alert("‚ö†Ô∏è Please complete the verification challenge first.");
          if (widgetId !== null) {
            window.turnstile.reset(widgetId);
          }
          return false;
        }

        isVerifying = true;
        const originalSubmitText = submitBtn.value || submitBtn.textContent;
        
        // Show loading state
        if (submitBtn.tagName === 'BUTTON') {
          submitBtn.textContent = "Verifying...";
        } else {
          submitBtn.value = "Verifying...";
        }
        submitBtn.disabled = true;

        let shouldSubmit = false;

        try {
          console.log("üîí Sending token to server for verification...");
          
          const res = await fetch(
            "https://yshome-cloudflare-api.vercel.app/api/verify",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token })
            }
          );

          // Check if response is ok BEFORE trying to parse JSON
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }

          const data = await res.json();
          console.log("üì° Server response:", data);

          if (!data || !data.success) {
            // Verification failed - block submission
            console.error("üö´ Spam detected or verification failed. Submission BLOCKED.");
            alert("‚ùå Verification failed. Please try again.");
            shouldSubmit = false;
          } else {
            // ‚úÖ Verification passed
            console.log("‚úÖ Verification passed!");
            verificationPassed = true;
            shouldSubmit = true;
          }

        } catch (err) {
          // ANY error (CORS, network, etc.) = BLOCK submission
          console.error("‚ùå Verification error (BLOCKING submission):", err);
          alert("‚ö†Ô∏è Verification service unavailable. Submission blocked. Please try again later.");
          shouldSubmit = false;
        } finally {
          // Always restore button state
          if (submitBtn.tagName === 'BUTTON') {
            submitBtn.textContent = originalSubmitText;
          } else {
            submitBtn.value = originalSubmitText;
          }
          submitBtn.disabled = false;
          isVerifying = false;

          // Reset widget if verification failed
          if (!shouldSubmit) {
            token = null;
            if (widgetId !== null) {
              window.turnstile.reset(widgetId);
            }
            return false; // CRITICAL: prevent submission
          }
        }

        // Only submit if verification passed
        if (shouldSubmit && verificationPassed) {
          console.log("‚úÖ Allowing form submission...");
          form.removeEventListener("submit", handleSubmit);
          HTMLFormElement.prototype.submit.call(form);
        }

        return false; // Always prevent default
      };

      form.addEventListener("submit", handleSubmit, true); // Use capture phase
    });
  }

  // Load Cloudflare Turnstile script
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      const script = document.createElement("script");
      script.src = "https://challenges.cloudflare.com/turnstile/v0/api.js";
      script.async = true;
      script.defer = true;
      script.onload = function() {
        // Wait a bit for Turnstile to fully initialize
        setTimeout(initTurnstile, 100);
      };
      script.onerror = function() {
        console.error("Failed to load Turnstile script");
      };
      document.head.appendChild(script);
    });
  } else {
    // DOM already loaded
    const script = document.createElement("script");
    script.src = "https://challenges.cloudflare.com/turnstile/v0/api.js";
    script.async = true;
    script.defer = true;
    script.onload = function() {
      setTimeout(initTurnstile, 100);
    };
    script.onerror = function() {
      console.error("Failed to load Turnstile script");
    };
    document.head.appendChild(script);
  }
})();
</script>

